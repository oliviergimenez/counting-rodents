---
title: "Estimating muskrats abundance"
author: "Olivier Gimenez"
date: "Dec 2024"
output: 
  html_document:
    toc: TRUE
    toc_depth: 2
    number_sections: true
    theme: united
    highlight: tango
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      cache = TRUE, 
                      message = FALSE, 
                      warning = FALSE, 
                      dpi = 600, 
                      fig.height=6, 
                      fig.width = 1.777777*6)
library(tidyverse)
theme_set(theme_light())
```

# Motivation

Here I illustrate the use of random effect site on abundance, and spatial autocorrelation. I use removal data on muskrats in the Netherlands. 

First things first, load the packages we will need:
```{r}
library(tidyverse)
library(sf)
library(cbsodataR)
library(ubms)
```

# Get data

Read in muskrat data:
```{r}
muskrats <- read_delim("data/occurrence-muskrats.txt")
head(muskrats)
```

Extract data for January, February and March:
```{r}
muskrats_3month <-  muskrats %>%
mutate(
  Start_Date = as.Date(sub("/.*", "", eventDate)),  # extract start date
  End_Date = as.Date(sub(".*/", "", eventDate))    # extract end date
) %>%
  rowwise() %>%  # apply operations row-wise
  # calculate the month and year with maximum overlap
  mutate(
    interval_dates = list(seq(Start_Date, End_Date, by = "day")),  # generate sequence of dates in the interval
    Overlapping_Month = {
      # find the month for each date
      month_names <- format(interval_dates, "%B")
      
      # determine the month with the maximum count
      max_month <- month_names %>%
        table() %>%
        which.max() %>%
        names()
      
      max_month
    },
    Overlapping_Year = {
      # find the year for each date
      year_values <- format(interval_dates, "%Y")
      
      # determine the year with the maximum count
      max_year <- year_values %>%
        table() %>%
        which.max() %>%
        names()
      
      max_year
    }
  ) %>%
  ungroup() %>%
  select(-interval_dates)
```

Make it an `sf` object:
```{r}
muskrats_sf <- muskrats_3month %>%
  filter(Overlapping_Month %in% c("January", "February", "March")) %>%
  group_by(year, Overlapping_Month, decimalLatitude, decimalLongitude) %>%
  summarise(n = sum(individualCount)) %>%
  mutate(month = Overlapping_Month) %>%
  st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), 
                        crs = 4326, 
                        agr = "constant")
```

Map the data by year after 2010:
```{r}
muskrats_sf %>% 
  filter(year > 2010) %>%
  ggplot() +
  geom_sf(aes(color = log(n))) + 
  scale_color_viridis_c() +
  labs(color = "number of removed \nmuskrats (log)") +
  facet_wrap(~year) +
  theme_void()
```

Map the data by month for year 2010:
```{r}
muskrats_sf %>% 
  filter(year == 2010) %>%
  ggplot() +
  geom_sf(aes(color = log(n))) + 
  scale_color_viridis_c() +
  labs(color = "number of removed \nmuskrats (log)") +
  facet_wrap(~month) +
  theme_void()
```

Get background map of netherlands w/ municipalities:
```{r}
# https://cran.r-project.org/web/packages/cbsodataR/vignettes/maps.html
cbs_maps <- cbs_get_maps()
netherlands <- cbs_get_sf("gemeente", 2023)

netherlands <- netherlands %>% 
  st_transform(crs = st_crs(muskrats_sf))
```

```{r}
plot(netherlands)
```


Now let's count the number of muskrats removed in each municipality. 
First we do a spatial join to associate points (muskrats) with polygons (cities):
```{r, eval=FALSE}
points_with_polygons <- st_join(muskrats_sf, 
                                netherlands, 
                                join = st_within)
```


Second, summarize counts:
```{r, eval=FALSE}
netherlands_with_counts <- points_with_polygons %>%
  group_by(statcode, month, year) %>% 
  summarize(
    total_n = sum(n, na.rm = TRUE),  
    .groups = "drop"
  )
```


Create all permutations of month, year and municipalities:
```{r, eval=FALSE}
all_months_years <- expand.grid(
  month = unique(muskrats_sf$month), 
  year = unique(muskrats_sf$year),
  statcode = netherlands$statcode
)
```


Fill in missing combinations of statcode, month, and year:
```{r, eval=FALSE}
netherlands_with_counts <- all_months_years %>%
  left_join(netherlands_with_counts %>% 
              st_drop_geometry(), # temporarily drop geometry to avoid mismatches
            by = c("statcode", "month", "year")) %>%
  mutate(total_n = ifelse(is.na(total_n), 0, total_n)) %>%
  right_join(netherlands, by = "statcode") %>%  # join back to netherlands
  st_as_sf()
```


Save files
```{r, eval=FALSE}
st_write(, "shp/netherland_muskrats.shp")
```

Read file:
```{r}
netherlands_with_counts <- st_read("shp/netherland_muskrats.shp")
```


Map by month:
```{r}
netherlands_with_counts %>% 
  ggplot() + 
  geom_sf(aes(fill=log(total_n)), color="#FFFFFF99") +
  scale_fill_viridis_c(direction = -1, option = "A")+ 
  labs(fill = "number of removed \nmuskrats (log)") +
  facet_wrap(~month) +
  theme_void()
```

Map by year (sum over months):
```{r}
netherlands_with_counts %>% 
  group_by(year, statcode) %>%
  summarise(n = sum(total_n)) %>%
  ggplot() + 
  geom_sf(aes(fill=log(n)), color="#FFFFFF99") +
  scale_fill_viridis_c(direction = -1)+ 
  labs(fill = "number of removed \nmuskrats (log)") +
  facet_wrap(~year) +
  theme_void()
```

Get temperatures:
```{r}
temp <- readRDS("data/temperature_netherlands.rds")
```

Pick muskrats removal data for year 2014:
```{r}
muskrats_ubms <- netherlands_with_counts %>%
  as_tibble %>%
  select(-geometry, - statnaam) %>%
  mutate(site = dense_rank(statcode)) %>% # renumber cities
  pivot_wider(
    names_from = month,
    values_from = total_n) %>% 
  select(January, February, March, site, statcode, year) %>%
  filter(year == 2014)
muskrats_ubms
```

Join muskrat removal data with covariate:
```{r}
muskrats_ubms <- muskrats_ubms %>% 
  left_join(temp)
```

Remove cities for which I have no temperature data:
```{r}
mask <- !is.na(muskrats_ubms[,7])
muskrats_ubms <- muskrats_ubms[mask,]
```

Get removal data:
```{r}
y <- as.matrix(muskrats_ubms[,c(1,2,3)])
```

For those cities where we have only 0's, replace by NA's as this probably means there was no effort:
```{r}
mask <- apply(y, 1, sum)
y[mask == 0, ] <- NA
```

Format site and observation covariates:
```{r}
site.covs <- data.frame(site = as_factor(muskrats_ubms$site),
                        temp = apply(muskrats_ubms[,7:9], 1, mean))

time <- matrix(c('january','february','march'),
               nrow = nrow(y),
               ncol = ncol(y), 
               byrow = TRUE)
```

Put everything in appropriate format for `ubms`:
```{r}
umf <- unmarkedFrameMPois(y = y, 
                          siteCovs = site.covs,
                          obsCovs = list(time = time),
                          type = "removal")

head(umf)
```

Fit model:
```{r}
fit <- stan_multinomPois(~time ~scale(temp) + (1|site), # detection, abundance in that order
                         data = umf, 
                         chains = 2, 
                         iter = 1000,
                         prior_intercept_state = normal(0, 1.5),
                         prior_coef_state = normal(0, 1.5))
fit
```

Check convergence:
```{r}
traceplot(fit, pars = c("beta_state", "beta_det"))
```

Get posterior densities:
```{r}
plot_posteriors(fit)#, pars=c("beta_state[SistemaSilvopastoril]"))
```

Plot abundance with respect to temperature:
```{r, eval=FALSE}
plot_marginal(fit, submodel = "state")
```

Get estimated capture probabilities:
```{r, eval=FALSE}
plot_marginal(fit, submodel = "det")
```

Report removal data and estimated abundance:
```{r}
cbind(apply(y, 1, sum), predict(fit, submodel="state"))
```


  <!-- ggspatial::annotation_scale(location = "bl", width_hint = 0.5) + -->
  <!-- ggspatial::annotation_north_arrow(location = "br",  -->
  <!--                                   which_north = "true",  -->
  <!--                                   style = ggspatial::north_arrow_fancy_orienteering) -->



# Session info

```{r}
sessionInfo()
```

